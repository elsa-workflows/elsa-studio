@using BlazorMonaco.Editor
@using Elsa.Studio.Workflows.Components.WorkflowDefinitionEditor.Components.WorkflowProperties
@using Orientation = Radzen.Orientation
@inherits StudioComponentBase
@using Elsa.Studio.Workflows.Services
@inject ILocalizer Localizer

<style>
    .pane-left {
        height: 100%;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .tabs-root {
        flex: 1 1 auto;
        min-height: 0;
    }
        .tabs-root .mud-tabs-panels {
            flex: 1 1 auto;
            min-height: 0;
        }

    .code-tab-content {
        height: 100%;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .editor-host {
        flex: 1 1 auto;
        min-height: 0;
        overflow: hidden;
    }

    .studio-expression-input-monaco-editor {
        height: 100% !important;
        width: 100% !important;
    }
</style>

<CascadingValue Value="this">
    <RadzenSplitter Orientation="Orientation.Horizontal" Style="height:100%;">
        <RadzenSplitterPane Size="65%" Class="pane-left">
            @if (_selectedWorkflowDefinition != null)
            {
                <MudDynamicTabs @ref="@_dynamicTabs"
                                @bind-ActivePanelIndex="@_tabIndex"
                                Class="tabs-root"
                                AddIconClass="d-none"
                                AddIconToolTip="@Localizer["Click to open a new workflow tab"]"
                                CloseIconToolTip="@Localizer["Close workflow"]"
                                Elevation="0"
                                ApplyEffectsToContainer>

                    <MudTabPanel Icon="@Icons.Material.Outlined.AccountTree"
                                 Text="@_selectedWorkflowDefinition.Name"
                                 ShowCloseIcon="false"
                                 Style="height:100%;">
                        @if (!IsReadOnly)
                        {
                            <WorkflowEditor @key="_selectedWorkflowDefinition.DefinitionId"
                                            @ref="WorkflowEditor"
                                            @bind-AutoSave="_autoSave"
                                            WorkflowDefinition="_selectedWorkflowDefinition"
                                            WorkflowDefinitionUpdated="OnWorkflowDefinitionUpdated"
                                            WorkflowDefinitionExecuted="WorkflowDefinitionExecuted"
                                            ActivitySelected="ActivitySelected" />
                        }
                        else
                        {
                            <WorkflowDefinitionVersionViewer @key="_selectedWorkflowDefinition.DefinitionId"
                                                             WorkflowDefinition="_selectedWorkflowDefinition"
                                                             WorkflowDefinitionExecuted="WorkflowDefinitionExecuted"
                                                             ActivitySelected="ActivitySelected" />
                        }
                    </MudTabPanel>
                    <MudTabPanel Icon="@Icons.Material.Outlined.Code"
                                 Text="@Localizer["Code View"]"
                                 ShowCloseIcon="false"
                                 Style="height:100%;">
                        <div class="code-tab-content">
                            <MudPaper Class="ma-2" Elevation="0" Outlined="true">
                                <MudToolBar Dense="true">
                                    <MudSpacer />
                                    <MudTooltip Text="@Localizer["Auto apply changes to editor."]">
                                        <MudSwitch T="bool"
                                                   @bind-Value="@_autoApply"
                                                   Color="Color.Primary"
                                                   Label="@Localizer["Auto-apply"]" />
                                    </MudTooltip>
                                    <MudTooltip Text="@Localizer["Apply changes to editor."]">
                                        <MudIconButton Icon="@Icons.Material.Outlined.Check"
                                                       Color="Color.Success"
                                                       Label="@Localizer["Apply"]"
                                                       OnClick="OnApplyClicked" />
                                    </MudTooltip>
                                </MudToolBar>
                                @if (!string.IsNullOrWhiteSpace(_applyErrorMessage))
                                {
                                    <MudAlert Severity="Severity.Error" Dense="true">
                                        <MudStack Row="true" AlignItems="MudBlazor.AlignItems.Center">
                                            @_applyErrorMessage
                                            <MudTooltip Text="@Localizer["Reload from editor"]">
                                                <MudIconButton Icon="@Icons.Material.Outlined.Refresh"
                                                               Size="Size.Small"
                                                               OnClick="ReloadMonacoClick" />
                                            </MudTooltip>
                                        </MudStack>
                                    </MudAlert>
                                }
                            </MudPaper>
                            <div class="editor-host">
                                <StandaloneCodeEditor @ref="_monacoEditor"
                                                      Id="@_monacoEditorId"
                                                      ConstructionOptions="ConfigureMonacoEditor"
                                                      OnDidChangeModelContent="OnMonacoContentChangedAsync"
                                                      CssClass="studio-expression-input-monaco-editor" />
                            </div>
                        </div>
                    </MudTabPanel>
                </MudDynamicTabs>
            }
        </RadzenSplitterPane>
        <RadzenSplitterPane Size="35%" Min="100px">
            @if (_selectedWorkflowDefinition != null)
            {
                <WorkflowProperties
                    WorkflowDefinition="@_selectedWorkflowDefinition"
                    WorkflowDefinitionUpdated="OnWorkflowDefinitionPropsUpdated"/>
            }
        </RadzenSplitterPane>
    </RadzenSplitter>
</CascadingValue>