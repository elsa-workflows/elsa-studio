@page "/secrets"
@using Elsa.Secrets
@using Elsa.Studio.Secrets
@using Variant = MudBlazor.Variant
@inherits StudioComponentBase
@using Elsa.Studio.Workflows.Services
@inject ElsaLocalization _localizer
@code
{
    private DateTime _now = DateTime.UtcNow;
}

<PageTitle>@_localizer["Secrets"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.False">
    <PageHeading Text="@_localizer["Secrets"]"/>

    <MudTable
        @ref="_table"
        T="SecretModel"
        ServerData="ServerReload"
        Dense="true"
        Hover="true"
        Elevation="0"
        OnRowClick="@OnRowClick"
        RowStyle="cursor: pointer;"
        MultiSelection="true"
        SelectOnRowClick="false"
        Class="definitions-table"
        @bind-SelectedItems="_selectedRows">
        <ToolBarContent>
            <MudMenu EndIcon="@Icons.Material.Filled.KeyboardArrowDown" Label="@_localizer["Bulk actions"]" Color="Color.Default" Variant="Variant.Filled">
                <MudMenuItem OnClick="@OnBulkDeleteClicked">@_localizer["Delete"]</MudMenuItem>
            </MudMenu>
            <MudSpacer/>
            
            <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled" DisableElevation="false">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@OnCreateClicked">@_localizer["Create Secret"]</MudButton>
            </MudButtonGroup>
        </ToolBarContent>
        <ColGroup>
            <col/>
            <col/>
            <col/>
            <col/>
            <col/>
            <col/>
        </ColGroup>
        <HeaderContent>
            <MudTh>
                <MudTableSortLabel SortLabel="Name" T="SecretModel">@_localizer["Name"]</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="Scope" T="SecretModel">@_localizer["Scope"]</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="Version" T="SecretModel">@_localizer["Version"]</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="Status" T="SecretModel">@_localizer["Status"]</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="Expires" T="SecretModel">@_localizer["Expires"]</MudTableSortLabel>
            </MudTh>
            <MudTh/>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Scope">@(context.Scope ?? "-")</MudTd>
            <MudTd DataLabel="Version">@context.Version</MudTd>
            <MudTd DataLabel="Status">@context.Status</MudTd>
            <MudTd DataLabel="Expires">@(context.ExpiresAt == null ? "Never" : (context.ExpiresAt!.Value - _now).ToHumanTimeString(3))</MudTd>
            <MudTd DataLabel="" Style="text-align:right">
                <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                    <MudMenuItem Icon="@Icons.Material.Outlined.Edit" OnClick="@(() => OnEditClicked(context.Id))">@_localizer["Edit"]</MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Outlined.Delete" OnClick="@(() => OnDeleteClicked(context))">@_localizer["Delete"]</MudMenuItem>
                </MudMenu>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>@_localizer["No secrets found"]</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudText>@_localizer["Loading"]...</MudText>
        </LoadingContent>
        <PagerContent>
            <MudTablePager/>
        </PagerContent>
    </MudTable>
</MudContainer>