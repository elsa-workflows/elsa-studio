@inherits StudioComponentBase
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@using System.Reflection

<Router AppAssembly="@typeof(App).Assembly" AdditionalAssemblies="@AdditionalAssemblies">
    <Found Context="routeData">
        @{
            // Check if current route is login page
            var isLoginPage = IsLoginRoute(routeData);
            var layoutType = isLoginPage ? typeof(BasicLayout) : typeof(MainLayout);
        }
        
        @if (!AuthorizationIsDisabled)
        {
            <CascadingAuthenticationState>
                <AuthorizeRouteView RouteData="routeData" DefaultLayout="@layoutType">
                    <Authorizing>
                        @if (!isLoginPage)
                        {
                            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; display: flex; justify-content: center; align-items: center; z-index: 9998;">
                                <div style="text-align: center;">
                                    <div style="width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top: 4px solid #1976d2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                                    <MudText Typo="Typo.body1">Checking authentication...</MudText>
                                </div>
                            </div>
                        }
                    </Authorizing>
                    <NotAuthorized>
                        @if (isLoginPage)
                        {
                            <RouteView RouteData="routeData" DefaultLayout="@typeof(BasicLayout)" />
                        }
                        else
                        {
                            @UnauthorizedComponentProvider.GetUnauthorizedComponent()
                        }
                    </NotAuthorized>
                </AuthorizeRouteView>
            </CascadingAuthenticationState>
        }
        else
        {
            <RouteView RouteData="routeData" DefaultLayout="@layoutType">
            </RouteView>
        }
        <FocusOnNavigate RouteData="@routeData" Selector="h1"/>
    </Found>
    <NotFound>
        <PageTitle>Not found</PageTitle>
        <LayoutView Layout="@typeof(MainLayout)">
            <MudAlert Severity="Severity.Info">Sorry, there's nothing at this address.</MudAlert>
        </LayoutView>
    </NotFound>
</Router>

<style>
    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Only hide loading screens if NOT on login page
            var currentUri = Navigation.Uri;
            var isLoginPage = currentUri.Contains("/login", StringComparison.OrdinalIgnoreCase);
            
            if (!isLoginPage)
            {
                // Hide the initial loading screen after the first render
                try
                {
                    await Task.Delay(300); // Small delay to ensure smooth transition
                    
                    // Try both Server and WASM hiding functions (one will work, one will be ignored)
                    await JSRuntime.InvokeVoidAsync("hideAuthLoading");  // Server
                    await JSRuntime.InvokeVoidAsync("hideWasmLoading");   // WASM
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to call loading screen hide functions: {ex.Message}");
                }
            }
        }
    }

    private bool IsLoginRoute(RouteData routeData)
    {
        // Check if the current route is the login page
        var routeTemplate = routeData.PageType.GetCustomAttribute<RouteAttribute>()?.Template;
        return routeTemplate?.Equals("/login", StringComparison.OrdinalIgnoreCase) == true ||
               Navigation.Uri.Contains("/login", StringComparison.OrdinalIgnoreCase);
    }
}
