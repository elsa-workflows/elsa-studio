@inherits StudioComponentBase
@inject IJSRuntime JSRuntime

<AuthenticationWrapper>
    <Router AppAssembly="@typeof(App).Assembly" AdditionalAssemblies="@AdditionalAssemblies">
        <Found Context="routeData">
            @if (!AuthorizationIsDisabled)
            {
                <CascadingAuthenticationState>
                    <AuthorizeRouteView RouteData="routeData" DefaultLayout="@typeof(MainLayout)">
                        <Authorizing>
                            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; display: flex; justify-content: center; align-items: center; z-index: 9998;">
                                <div style="text-align: center;">
                                    <div style="width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top: 4px solid #1976d2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                                    <MudText Typo="Typo.body1">Checking authentication...</MudText>
                                </div>
                            </div>
                        </Authorizing>
                        <NotAuthorized>
                            @UnauthorizedComponentProvider.GetUnauthorizedComponent()
                        </NotAuthorized>
                    </AuthorizeRouteView>
                </CascadingAuthenticationState>
            }
            else
            {
                <RouteView RouteData="routeData" DefaultLayout="@typeof(MainLayout)">
                </RouteView>
            }
            <FocusOnNavigate RouteData="@routeData" Selector="h1"/>
        </Found>
        <NotFound>
            <PageTitle>Not found</PageTitle>
            <LayoutView Layout="@typeof(MainLayout)">
                <MudAlert Severity="Severity.Info">Sorry, there's nothing at this address.</MudAlert>
            </LayoutView>
        </NotFound>
    </Router>
</AuthenticationWrapper>

<style>
    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Hide the initial loading screen after the first render
            try
            {
                await Task.Delay(300); // Small delay to ensure smooth transition
                await JSRuntime.InvokeVoidAsync("hideAuthLoading");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to call hideAuthLoading: {ex.Message}");
            }
        }
    }
}
